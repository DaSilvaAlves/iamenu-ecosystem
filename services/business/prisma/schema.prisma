// Prisma Schema - Business Intelligence API - SQLite (Local Development)

generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["business"]
}

// Restaurant (1 por user)
model Restaurant {
  id             String   @id @default(uuid())
  userId         String   @unique // FK para user do Community

  // Dados Básicos (Step 1)
  name           String
  address        String?
  cuisine        String   // 'portuguesa', 'italiana', 'japonesa', etc
  tables         Int?
  openHour       String?  // "12:00"
  closeHour      String?  // "23:00"

  // Financeiro (Step 3)
  monthlyCosts   Decimal? @db.Decimal(12,2)  // Custos fixos mensais
  staffCount     Int?
  averageTicket  Decimal? @db.Decimal(10,2)  // Ticket médio atual
  suppliers      String?  // Lista de fornecedores (comma-separated)

  // Metadata
  onboardingCompleted Boolean @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  products       Product[]
  orders         Order[]
  settings       RestaurantSettings?

  @@index([userId])
  @@map("restaurants")
  @@schema("business")
}

// Configurações e Metas (Step 4)
model RestaurantSettings {
  id               String @id @default(uuid())
  restaurantId     String @unique

  // Objetivos (Step 4)
  revenueGoal      Decimal? @db.Decimal(12,2)  // Meta de receita mensal
  foodCostTarget   Decimal? @db.Decimal(5,2)  // Food cost % ideal (ex: 30)
  tableRotation    Int?    // Rotação de mesa alvo
  segment          String? // 'fast-casual', 'casual', 'fine-dining', 'fast-food'

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  restaurant       Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("restaurant_settings")
  @@schema("business")
}

// Produtos/Pratos do Menu
model Product {
  id             String   @id @default(uuid())
  restaurantId   String

  // Dados do Produto
  name           String
  category       String   // 'Main Course', 'Appetizer', 'Dessert', 'Beverage'
  price          Decimal  @db.Decimal(10,2)  // Preço de venda
  cost           Decimal  @db.Decimal(10,2)  // Custo de produção (food cost)
  description    String?

  // Métricas
  popularity     Int      @default(0)  // 0-10 (manual ou calculado por vendas)
  sales          Int      @default(0)  // Total de vendas
  totalRevenue   Decimal  @default(0) @db.Decimal(12,2)  // Receita total gerada

  // Flags
  isActive       Boolean  @default(true)

  // Metadata
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  restaurant     Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderItems     OrderItem[]

  @@index([restaurantId])
  @@map("products")
  @@schema("business")
}

// Vendas/Pedidos
model Order {
  id             String   @id @default(uuid())
  restaurantId   String

  // Dados do Pedido
  customerId     String?  // Opcional: FK para customer (futuro)
  total          Decimal  @db.Decimal(12,2)  // Valor total do pedido
  status         String   @default("completed") // 'pending', 'completed', 'cancelled'

  // Metadata
  orderDate      DateTime @default(now())
  createdAt      DateTime @default(now())

  // Relations
  restaurant     Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  items          OrderItem[]

  @@index([restaurantId])
  @@index([status])
  @@index([restaurantId, orderDate(sort: Desc)])
  @@map("orders")
  @@schema("business")
}

// Itens de cada pedido
model OrderItem {
  id             String   @id @default(uuid())
  orderId        String
  productId      String

  quantity       Int
  priceAtTime    Decimal  @db.Decimal(10,2)  // Preço no momento da venda
  costAtTime     Decimal  @db.Decimal(10,2)  // Custo no momento da venda

  order          Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product        Product  @relation(fields: [productId], references: [id], onDelete: Restrict)

  @@map("order_items")
  @@schema("business")
}

// Analytics Cache (Opcional - para performance)
model DailyStats {
  id             String   @id @default(uuid())
  restaurantId   String
  date           DateTime

  revenue        Decimal  @db.Decimal(12,2)
  customers      Int
  avgTicket      Decimal  @db.Decimal(10,2)
  foodCostPct    Decimal  @db.Decimal(5,2)

  createdAt      DateTime @default(now())

  @@unique([restaurantId, date])
  @@index([restaurantId])
  @@index([date(sort: Desc)])
  @@map("daily_stats")
  @@schema("business")
}
