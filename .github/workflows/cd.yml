name: CD - Deploy to Railway

on:
  push:
    branches: [main]
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

env:
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  deploy-decision:
    name: Decide Deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.workflow_run.conclusion == 'success'
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
    steps:
      - name: Check if CI passed
        id: check
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy Services to Railway
    runs-on: ubuntu-latest
    needs: deploy-decision
    if: needs.deploy-decision.outputs.should_deploy == 'true'
    strategy:
      matrix:
        service:
          - community-api
          - marketplace-api
          - academy-api
          - business-api
      max-parallel: 2
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy ${{ matrix.service }} to Railway
        run: |
          npm install -g @railway/cli
          railway up --service ${{ matrix.service }}
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

  deploy-frontend:
    name: Deploy Frontend to Railway
    runs-on: ubuntu-latest
    needs: deploy-decision
    if: needs.deploy-decision.outputs.should_deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Frontend to Railway
        run: |
          npm install -g @railway/cli
          railway up --service prototype-vision
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        continue-on-error: true

  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy, deploy-frontend]
    if: always()

    steps:
      - name: Deployment Complete
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ] && [ "${{ needs.deploy-frontend.result }}" == "success" ]; then
            echo "✅ All services deployed successfully to Railway"
            exit 0
          else
            echo "⚠️  Some services may have failed. Check Railway dashboard."
            exit 1
          fi
